# 测试: 数据库表结构重构（Level 4 - Plan 审批）

## 元信息
- **Level**: 4
- **类型**: plan
- **决策点数量**: 3
- **风险等级**: high

## 原始输入
Plan: 用户表拆分与订单系统重构

## 背景
当前用户表 ~500万行，包含个人信息、认证、订单统计等多类数据：
- 查询性能下降（单表过大）
- 敏感信息（密码、身份证）与应用数据混在一起
- 难以做读写分离

## 实施计划

### Step 1: 新表设计

**需要决策1: 拆分策略**

选项 A: 垂直拆分（按字段）
- users: id, username, email, password_hash（认证相关）
- user_profiles: user_id, name, phone, id_card, address（个人信息）
- user_stats: user_id, total_orders, total_amount（统计数据）
- 优点: 敏感数据隔离，查询精准
- 缺点: 需要 JOIN，代码改动大

选项 B: 水平拆分（按用户ID哈希）
- users_0, users_1, users_2, users_3
- 优点: 单表数据量减少，水平扩展容易
- 缺点: 跨分片查询复杂，需改路由逻辑

选项 C: 混合方案
- 垂直拆分 auth + profile
- 统计数据保留在原表（只读）
- 优点: 平衡方案，改动适中
- 缺点: 没有彻底解决单表问题

### Step 2: 双写阶段（2周）
⚠️ **风险**: 双写期间性能下降 10-15%
- 写操作同时更新旧表和新表
- 读操作仍从旧表读取
- 每天校验数据一致性

### Step 3: 数据迁移

**需要决策2: 迁移窗口策略**

选项 A: 停机迁移
- 凌晨 2:00-4:00 维护窗口
- 预估停机 2 小时
- 简单安全，但影响用户体验

选项 B: 在线迁移（推荐）
- 使用 pt-online-schema-change
- 零停机，但工具复杂度高
- 需要 DBA 全程监控

### Step 4: 索引重建
- 新表需要重新设计索引策略
- 预估重建时间: 4-6 小时

**需要决策3: 索引策略**

选项 A: 完全复制现有索引
- 安全保守
- 可能保留无效索引

选项 B: 重新设计索引（推荐）
- 基于慢查询日志优化
- 删除冗余索引，添加复合索引
- 需要压测验证

### Step 5: 应用切换
- 读操作切换到新表
- 监控错误率和响应时间
- 保留旧表 30 天（可回滚）

### Step 6: 旧表清理
⚠️ **风险**: 清理后无法回滚
- 确认业务正常 30 天后执行
- 先 rename 再 drop（保险策略）

## 风险矩阵

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 数据不一致 | 中 | 高 | 双写校验 + 一致性检查 |
| 迁移失败 | 低 | 极高 | 完整备份 + 回滚脚本 |
| 性能下降 | 高 | 中 | 灰度切换 + 监控 |
| 业务中断 | 低 | 极高 | 维护窗口/在线工具 |

## 工作量评估
- 方案设计: 2 天
- 代码改造: 5 天
- 双写阶段: 14 天（并行）
- 数据迁移: 1 天
- 验证测试: 3 天
- **总计: 约 4 周**

## 回滚方案
每个阶段都有对应的回滚策略：
- Step 1-2: 直接废弃新表，无影响
- Step 3-4: 切回旧表读，同步修复数据
- Step 5 后: 无法回滚，需数据修复脚本

请确认：
1. 拆分策略: 垂直 / 水平 / 混合 ?
2. 迁移窗口: 停机 / 在线 ?
3. 索引策略: 复制现有 / 重新设计 ?

## 期望输出

### 判定
Level 4 - Plan审批（复杂数据库迁移，多决策点，高风险）

### 语音版
用户表重构，500万行拆分。3个决策：拆分策略、迁移窗口、索引设计。双写期性能降10%。

### HUD版
L1: 🗄️ 用户表重构 Plan (6步)
L2: ❓ 决策1/3：拆分策略
L3:   A: 垂直（字段分离）
L4:   B: 水平（哈希分片）/ C: 混合

### 决策点
- 决策1: 拆分策略 → 垂直（字段分离）/ 水平（哈希）/ 混合
- 决策2: 迁移窗口 → 停机（简单）/ 在线（零停机）
- 决策3: 索引策略 → 复制现有 / 重新设计

### 风险
- 双写期间性能下降 10-15%
- Step 3 数据迁移失败风险
- Step 6 旧表清理后无法回滚

### 压缩摘要
6步重构计划，500万行用户表拆分：
1. 新表设计 [决策1：拆分策略]
2. 双写阶段（2周）⚠️性能降10-15%
3. 数据迁移 [决策2：迁移窗口]
4. 索引重建 [决策3：索引策略]
5. 应用切换
6. 旧表清理 ⚠️无法回滚

预估4周，需维护窗口或在线工具。

## 测试说明
复杂数据库迁移场景，测试 triage 能否：
1. 识别多个决策点（3个）
2. 提取所有风险（4个）
3. 压缩复杂的技术细节为可管理的决策流程
4. 保持关键信息（数据量、时间估算、回滚策略）
